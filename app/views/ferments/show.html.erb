<div class="container ferment-page my-5 p-4 rounded-4 shadow-sm">

  <div class="text-center mb-4">
    <h1 class="ferment-title mb-2"><%= @ferment.name %></h1>
    <div class="d-flex justify-content-center gap-2 flex-wrap">
      <%= link_to "â† Volver al perfil", profile_path(@ferment.user), class: "btn btn-outline-primary btn-sm" %>
      <%= link_to "Todos los fermentos", ferments_path, class: "btn btn-outline-primary btn-sm" %>
      <% if user_signed_in? && @ferment.user == current_user %>
        <%= link_to "âœï¸ Editar", edit_ferment_path(@ferment), class: "btn btn-outline-success btn-sm" %>
      <% end %>
    </div>
  </div>

  <section class="ferment-details p-4 mb-5 rounded-3 shadow-sm">
    <p><strong>   DescripciÃ³n:</strong> <%= @ferment.description %></p>
    <p><strong>ğŸ§‚ Ingredientes:</strong> <%= @ferment.ingredients %></p>
    <p><strong>ğŸ“‹ Instrucciones:</strong> <%= @ferment.instructions %></p>
    <p><strong>ğŸ—“ï¸ Fecha de inicio:</strong> <%= @ferment.formatted_start_date %></p>
    <p><strong>â° Revisar en:</strong> <%= @ferment.revisar_fermentos %> dÃ­as</p>
  </section>

  <% if @ferment.photos.attached? %>
    <section class="ferment-gallery row g-3 mb-5">
      <% @ferment.photos.each do |photo| %>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="ferment-photo-card position-relative rounded-3 shadow-sm overflow-hidden">
            <%= image_tag photo, class: "img-fluid" %>
            <p class="photo-date m-2"><i class="bi bi-calendar"></i> <%= photo.created_at.strftime("%d/%m/%Y") %></p>

            <% if user_signed_in? && @ferment.user == current_user %>
              <%= button_to destroy_photo_user_ferment_path(@ferment.user, @ferment, photo_id: photo.id),
                  method: :delete,
                  data: { confirm: "Seguro que querÃ©s eliminar esta foto?" },
                  class: "btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" do %>
                <i class="bi bi-x-lg"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </section>
  <% else %>
    <p class="text-center text-muted">No hay fotos disponibles.</p>
  <% end %>

  <section class="comments-section mb-5">
    <div class="comments-header mb-3">
      <h4 class="text-primary text-center">Comentarios (<%= @comments.count %>)</h4>
    </div>

    <% if user_signed_in? %>
      <%= form_with(model: [@ferment.user, @ferment, @comment], local: true, class: "comment-form mb-4") do |form| %>
        <div class="mb-3">
          <%= form.text_field :title, placeholder: "TÃ­tulo", class: "form-control rounded-3" %>
        </div>
        <div class="mb-3">
          <%= form.text_area :content, placeholder: "Comentario", rows: 4, class: "form-control rounded-3" %>
        </div>
        <div class="text-center">
          <%= form.submit "Comentar", class: "btn btn-primary w-50" %>
        </div>
      <% end %>
    <% end %>

    <% if @comments.any? %>
      <% @comments.each do |comment| %>
        <div class="comment-card p-3 rounded-3 shadow-sm mb-3 d-flex gap-3">
          <% if comment.user.photo.attached? %>
            <%= image_tag comment.user.photo.variant(resize_to_fill: [50,50]),
                class: "rounded-circle comment-avatar" %>
          <% else %>
            <div class="default-avatar rounded-circle"></div>
          <% end %>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <strong class="text-dark"><%= comment.title %></strong>
              <% if user_signed_in? && comment.user == current_user %>
                <%= button_to user_ferment_comment_path(@ferment.user, @ferment, comment),
                    method: :delete,
                    data: { confirm: "Â¿Eliminar comentario?" },
                    class: "btn btn-sm btn-outline-danger ms-2" do %>
                  <i class="bi bi-trash"></i>
                <% end %>
              <% end %>
            </div>
            <div class="text-muted small mb-2">
              Por <%= link_to comment.user.full_name, comment.user, class: "text-decoration-none text-primary" %>
              â€¢ <%= time_ago_in_words(comment.created_at) %> atrÃ¡s
            </div>
            <p class="mb-0 text-dark"><%= comment.content %></p>
          </div>
        </div>
      <% end %>
    <% else %>
      <p class="text-center text-muted">SÃ© el primero en comentar ğŸ“</p>
    <% end %>
  </section>
</div>
