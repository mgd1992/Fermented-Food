<div id="ferment_form">

  <%= form_with(model: [current_user, ferment], html: { multipart: true }) do |form| %>
    <h2 class="text-center mb-4 fw-semibold">
      <%= ferment.new_record? ? "Nuevo fermento" : "Editar fermento" %>
    </h2>

    <% if ferment.errors.any? %>
      <div class="alert alert-danger">
        <p class="fw-semibold mb-2">No se pudo guardar el fermento:</p>
        <ul class="mb-0">
          <% ferment.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mb-4">
      <%= form.label :name, "Nombre del fermento", class: "form-label" %>
      <%= form.text_field :name, class: "form-control form-control-lg", placeholder: "Ej: Kimchi clásico" %>

      <%= form.label :description, "Descripción", class: "form-label mt-3" %>
      <%= form.text_area :description, rows: 3, class: "form-control", placeholder: "Descripción breve" %>

      <%= form.label :ingredients, "Ingredientes", class: "form-label mt-3" %>
      <%= form.text_area :ingredients, rows: 3, class: "form-control", placeholder: "Ej: repollo, sal, ajo, jengibre" %>

      <%= form.label :instructions, "Pasos de preparación", class: "form-label mt-3" %>
      <%= form.text_area :instructions, rows: 4, class: "form-control", placeholder: "Ej: cortar, salar, fermentar en frasco" %>
    </div>

    <div class="mb-4">
      <%= form.label :fermentation_time, "Duración estimada", class: "form-label" %>
      <%= form.text_field :fermentation_time, class: "form-control", placeholder: "Ej: 7 días" %>

      <%= form.label :start_date, "Fecha de inicio", class: "form-label mt-3" %>
      <%= form.text_field :start_date, class: "form-control", data: { controller: "datepicker" } %>

      <%= form.label :revisar_fermentos, "Cada cuántos días revisarlo", class: "form-label mt-3" %>
      <%= form.number_field :revisar_fermentos, min: 1, class: "form-control", placeholder: "Ej: 3" %>
    </div>

    <div class="mb-4">
      <p class="text-uppercase text-muted small fw-semibold mb-3">Fotos del fermento</p>

      <% if ferment.photos.attached? %>
        <div class="d-flex flex-wrap gap-2 mb-3">
          <% ferment.photos.each do |photo| %>
            <div id="ferment_photo_<%= photo.id %>" class="position-relative">
              <%= image_tag photo.variant(resize_to_limit: [100, 100]), class: "rounded border" %>
              <%# Link para borrar foto individualmente %>
              <%= link_to "×", destroy_photo_ferment_path(ferment, photo_id: photo.id),
                  data: { turbo_method: :delete, turbo_confirm: "¿Borrar foto?" },
                  class: "btn btn-danger btn-sm position-absolute top-0 end-0 py-0 px-1" %>
            </div>
          <% end %>
        </div>
      <% end %>

      <%= form.label :photos, "Agregar más fotos", class: "form-label" %>
      <%= form.file_field :photos, multiple: true, class: "form-control" %>
      <div class="form-text">Las fotos anteriores se mantendrán a menos que las borres manualmente.</div>
    </div>

    <div class="d-grid gap-2 mt-4">
      <%= form.submit (ferment.persisted? ? "Guardar cambios" : "Crear fermento"), class: "btn btn-primary btn-lg" %>
      <%
        cancel_path = if ferment.persisted?
                        ferment_path(ferment)
                      else
                        session[:return_to] || ferments_path
                      end
      %>

      <%= link_to "Cancelar", cancel_path, class: "btn btn-outline-secondary btn-lg", data: { turbo_frame: "_top" } %>
    </div>
  <% end %>

</div>
